<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Å—Å–∞ —Å –∞–¥–º–∏–Ω–∫–æ–π</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h2 {
      margin-top: 30px;
    }
    input, button, select, textarea {
      padding: 10px;
      width: 100%;
      margin: 8px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    video {
      width: 100%;
      max-width: 400px;
      display: block;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    .receipt {
      border: 1px dashed #aaa;
      padding: 10px;
      margin-top: 20px;
      background: #fffbea;
    }
    canvas.barcode {
      height: 50px;
      margin-top: 5px;
    }
    .hidden {
      display: none;
    }
    .admin-only {
      background: #eef; border-left: 4px solid #36f; padding: 10px; margin: 10px 0;
    }
  </style>
</head>
<body>

<div class="container">

  <!-- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ -->
  <h2>üîê –í—Ö–æ–¥</h2>
  <button onclick="switchToCashier()">–ö–∞—Å—Å–∏—Ä</button>
  <button onclick="showAdminLogin()">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>

  <!-- –õ–æ–≥–∏–Ω –∞–¥–º–∏–Ω–∞ -->
  <div id="adminLogin" class="hidden">
    <input type="text" id="loginUser" placeholder="–õ–æ–≥–∏–Ω" />
    <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å" />
    <button onclick="loginAdmin()">–í–æ–π—Ç–∏</button>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–∞—Å—Å—ã -->
  <div id="cashierMode" class="hidden">

    <!-- –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä -->
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
    <input type="text" id="newProductName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" />
    <input type="number" id="newProductPrice" placeholder="–¶–µ–Ω–∞" />
    <button onclick="addNewProduct()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>

    <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <h2>üì¶ –¢–æ–≤–∞—Ä—ã</h2>
    <div id="productsList"></div>

    <!-- –ü–æ–∏—Å–∫ / —Å–∫–∞–Ω–µ—Ä -->
    <h2>üîç –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä</h2>
    <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥..." />
    <button onclick="findProduct()">–ù–∞–π—Ç–∏</button>
    <video id="preview"></video>
    <button onclick="startScanner()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>

    <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
    <h2>üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
    <table id="cartTable">
      <tr><th>–¢–æ–≤–∞—Ä</th><th>–¶–µ–Ω–∞</th></tr>
    </table>
    <h3>–ò—Ç–æ–≥–æ: <span id="total">0</span> ‚ÇΩ</h3>

    <!-- –û–ø–ª–∞—Ç–∞ -->
    <h2>üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h2>
    <select id="paymentMethod">
      <option value="card">–ö–∞—Ä—Ç–∞</option>
      <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
      <option value="online">–û–Ω–ª–∞–π–Ω (QR)</option>
    </select>
    <button onclick="checkout()">–û–ø–ª–∞—Ç–∏—Ç—å</button>

    <!-- –ß–µ–∫ -->
    <div class="receipt" id="receipt" style="display:none;"></div>

  </div>

  <!-- –ê–¥–º–∏–Ω–∫–∞ -->
  <div id="adminPanel" class="hidden admin-only">
    <h2>üìä –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂</h2>
    <div id="salesHistory"></div>

    <h2>üóë –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</h2>
    <button onclick="clearAllData()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
  </div>

</div>

<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<script src="https://unpkg.com/ @zxing/library@latest/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode @3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js "></script>

<script>
  // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
  const ADMIN_LOGIN = "admin";
  const ADMIN_PASS = "1234";

  // === –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ —ç–∫—Ä–∞–Ω–æ–≤ ===
  function switchToCashier() {
    document.getElementById("cashierMode").classList.remove("hidden");
    document.getElementById("adminLogin").classList.add("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
  }

  function showAdminLogin() {
    document.getElementById("adminLogin").classList.remove("hidden");
    document.getElementById("cashierMode").classList.add("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
  }

  function loginAdmin() {
    const user = document.getElementById("loginUser").value;
    const pass = document.getElementById("loginPass").value;
    if (user === ADMIN_LOGIN && pass === ADMIN_PASS) {
      document.getElementById("adminPanel").classList.remove("hidden");
    } else {
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
    }
  }

  // === –†–∞–±–æ—Ç–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ ===
  let products = JSON.parse(localStorage.getItem("products")) || {};
  let cart = [];
  let sales = JSON.parse(localStorage.getItem("sales")) || [];

  function saveProducts() {
    localStorage.setItem("products", JSON.stringify(products));
  }

  function saveSales() {
    localStorage.setItem("sales", JSON.stringify(sales));
  }

  function renderProducts() {
    const list = document.getElementById("productsList");
    list.innerHTML = "";
    for (const code in products) {
      const p = products[code];
      list.innerHTML += `
        <div style="margin-bottom: 20px; border: 1px solid #ccc; padding: 10px;">
          <strong>${p.name}</strong> ‚Äî ${p.price} ‚ÇΩ<br/>
          –®—Ç—Ä–∏—Ö–∫–æ–¥: <code>${code}</code><br/>
          <canvas class="barcode" data-value="${code}"></canvas>
        </div>
      `;
    }
    JsBarcode(".barcode").init();
  }

  function addNewProduct() {
    const name = document.getElementById("newProductName").value.trim();
    const price = parseFloat(document.getElementById("newProductPrice").value);
    if (!name || isNaN(price)) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");

    const code = generateUniqueCode();
    products[code] = { name, price };
    saveProducts();
    renderProducts();
  }

  function generateUniqueCode() {
    let code;
    do {
      code = Math.floor(Math.random() * 900000000000 + 100000000000).toString();
    } while (products[code]);
    return code;
  }

  function findProduct() {
    const query = document.getElementById("searchInput").value.trim().toLowerCase();
    const product = products[query];
    if (product) {
      cart.push(product);
      updateCart();
    } else {
      alert("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω");
    }
  }

  function updateCart() {
    const cartTable = document.getElementById("cartTable");
    cartTable.innerHTML = "<tr><th>–¢–æ–≤–∞—Ä</th><th>–¶–µ–Ω–∞</th></tr>";
    let totalSum = 0;
    cart.forEach(item => {
      cartTable.innerHTML += `<tr><td>${item.name}</td><td>${item.price} ‚ÇΩ</td></tr>`;
      totalSum += item.price;
    });
    document.getElementById("total").innerText = totalSum;
  }

  // === –°–∫–∞–Ω–µ—Ä ===
  let codeReader = new ZXing.BrowserMultiFormatReader();
  async function startScanner() {
    try {
      const videoInputDevices = await codeReader.listVideoInputDevices();
      const firstDeviceId = videoInputDevices[0].deviceId;
      codeReader.decodeFromVideoDevice(firstDeviceId, 'preview', (result, err) => {
        if (result) {
          document.getElementById("searchInput").value = result.text;
          findProduct();
          codeReader.reset();
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error(err);
        }
      });
    } catch (error) {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É.");
      console.error(error);
    }
  }

  // === –ü–æ–∫—É–ø–∫–∞ –∏ —á–µ–∫ ===
  function checkout() {
    if (cart.length === 0) return alert("–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É!");

    const payment = document.getElementById("paymentMethod").value;
    const receiptDiv = document.getElementById("receipt");
    receiptDiv.style.display = "block";
    receiptDiv.innerHTML = `<h3>üßæ –í–∞—à —á–µ–∫:</h3>`;
    receiptDiv.innerHTML += `<ul>`;
    cart.forEach(item => {
      receiptDiv.innerHTML += `<li>${item.name} ‚Äî ${item.price} ‚ÇΩ</li>`;
    });
    receiptDiv.innerHTML += `</ul>`;

    const totalSum = cart.reduce((sum, item) => sum + item.price, 0);
    receiptDiv.innerHTML += `<p><strong>–°—É–º–º–∞:</strong> ${totalSum} ‚ÇΩ</p>`;
    receiptDiv.innerHTML += `<p><strong>–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã:</strong> ${payment === "card" ? "–ö–∞—Ä—Ç–∞" : payment === "cash" ? "–ù–∞–ª–∏—á–Ω—ã–µ" : "–û–Ω–ª–∞–π–Ω"}</p>`;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–¥–∞–∂—É
    sales.push({
      date: new Date().toLocaleString(),
      items: [...cart],
      total: totalSum,
      method: payment
    });
    saveSales();

    cart = [];
    updateCart();
  }

  // === –ê–¥–º–∏–Ω–∫–∞ ===
  function renderSalesHistory() {
    const history = document.getElementById("salesHistory");
    history.innerHTML = "";
    if (sales.length === 0) {
      history.innerHTML = "<p>–ü—Ä–æ–¥–∞–∂ –ø–æ–∫–∞ –Ω–µ—Ç.</p>";
      return;
    }

    sales.forEach(sale => {
      history.innerHTML += `
        <div style="border-bottom: 1px solid #ccc; padding: 10px 0;">
          <strong>–î–∞—Ç–∞:</strong> ${sale.date}<br/>
          <strong>–°—É–º–º–∞:</strong> ${sale.total} ‚ÇΩ<br/>
          <strong>–ú–µ—Ç–æ–¥:</strong> ${sale.method}<br/>
          <ul>
            ${sale.items.map(i => `<li>${i.name} ‚Äî ${i.price} ‚ÇΩ</li>`).join("")}
          </ul>
        </div>
      `;
    });
  }

  function clearAllData() {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")) {
      localStorage.clear();
      location.reload();
    }
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ ===
  renderProducts();
  renderSalesHistory();
</script>

</body>
</html>

